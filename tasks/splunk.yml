---
- name: set splunk package path based on file type
  set_fact:
    splunk_package_path: >-
      {%- if ludus_ar_splunk_url.endswith('.deb') -%}
        /opt/splunk.deb
      {%- else -%}
        /opt/splunk.tgz
      {%- endif -%}
    splunk_is_deb: "{{ ludus_ar_splunk_url.endswith('.deb') }}"

- name: download splunk
  get_url:
    url: "{{ ludus_ar_splunk_url }}"
    dest: "{{ splunk_package_path }}"
    force: no
  register: splunk_download

- name: disable and stoping service if exists
  service:
    name: splunkd
    state: stopped
  register: result_systemd_stop
  failed_when: "result_systemd_stop is failed and 'Could not find the requested service' not in result_systemd_stop.msg"
  when: splunk_download.changed | default(false)

- name: update apt cache
  ansible.builtin.apt:
    update_cache: yes
  become: yes
  when:
    - splunk_download.changed | default(false)
    - splunk_is_deb | default(false)

- name: install splunk binary from deb package
  ansible.builtin.apt:
    deb: "{{ splunk_package_path }}"
    state: present
  become: yes
  when:
    - splunk_download.changed | default(false)
    - splunk_is_deb | default(false)

- name: install splunk binary from tarball
  unarchive:
    remote_src: yes
    src: "{{ splunk_package_path }}"
    dest: /opt/
    creates: /opt/splunk/bin/splunk
  become: yes
  when:
    - splunk_download.changed | default(false)
    - not (splunk_is_deb | default(false))

- name: check if splunk binary exists
  stat:
    path: /opt/splunk/bin/splunk
  register: splunk_binary

- name: configure splunk for Docker filesystem compatibility
  lineinfile:
    path: /opt/splunk/etc/splunk-launch.conf
    line: "OPTIMISTIC_ABOUT_FILE_LOCKING = 1"
    create: yes
    state: present
  become: yes
  when: splunk_binary.stat.exists

- name: accept license and start splunk
  shell: /opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt --seed-passwd {{ ludus_ar_splunk_password }}
  become: yes
  register: splunk_start_result
  failed_when: false
  changed_when: false
  when: splunk_binary.stat.exists

- name: wait for splunk to be ready (check status with retries)
  command: /opt/splunk/bin/splunk status
  register: splunk_status_result
  until: splunk_status_result.rc == 0
  retries: 12
  delay: 5
  changed_when: false
  become: yes
  when: splunk_binary.stat.exists

- name: check if boot-start is enabled
  command: /opt/splunk/bin/splunk status boot-start
  register: boot_start_status
  changed_when: false
  failed_when: false
  become: yes
  when: splunk_binary.stat.exists

- name: enable boot-start
  shell: /opt/splunk/bin/splunk enable boot-start
  become: yes
  when: splunk_binary.stat.exists and (boot_start_status.rc | default(1) != 0)
